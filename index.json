[{"content":"hugoæ­å»ºåšå®¢ hugoå‡†å¤‡ å®‰è£… # mac os brew install hugo # ubuntu sudo apt-get install hugo åˆ›å»ºåšå®¢é¡¹ç›® æ–°å»ºsite # åˆ›å»ºhugoé¡¹ç›® hugo new site my_blog_site # åˆå§‹åŒ–gitä»“åº“ cd my_blog_site \u0026amp;\u0026amp; git init æŒ‡å®šä¸»é¢˜ 1.æ‹‰å–ä¸»é¢˜æ–‡ä»¶åˆ°siteç›®å½•ä¸‹çš„themesæ–‡ä»¶å¤¹å†…ï¼ˆä½¿ç”¨submoduleç®¡ç†å­é¡¹ç›®ï¼‰\n# æ‹‰å–anankeä¸»é¢˜ git submodule add https://github.com/theNewDynamic/gohugo-theme-ananke.git themes/ananke # æ‹‰å–papermodeä¸»é¢˜ git submodule add --depth=1 https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod git submodule update --init --recursive # æ›´æ–°æŸä¸ªthemes(å­é¡¹ç›®) git submodule update --remote --merge 2.åœ¨é…ç½®ä¸­æŒ‡æ˜ä½¿ç”¨çš„ä¸»é¢˜(å¯ä»¥ä¸‹è½½å¤šä¸ªä¸»é¢˜æ–‡ä»¶ï¼Œåœ¨é…ç½®ä¸­æŒ‡å®šå“ªä¸ªç”Ÿæ•ˆ)\necho theme = \\\u0026#34;ananke\\\u0026#34; \u0026gt;\u0026gt; config.toml æŒ‡å®šå†…å®¹æ–‡ä»¶ å¯ä»¥ç›´æ¥æ‰‹åŠ¨åˆ›å»ºmdæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨hugoæä¾›çš„å¦‚ä¸‹å‘½ä»¤åˆ›å»ºï¼Œæ–‡ä»¶çˆ¶ç›®å½•ä»£è¡¨â€™CATEGORYâ€˜\nhugo new posts/my-first-post.md å¼•ç”¨å›¾ç‰‡ hugoé»˜è®¤ä¼šå°†staticæ–‡ä»¶å¤¹ä¸­çš„èµ„æºæ–‡ä»¶æŒ‚è½½åˆ°æœ€ç»ˆæœåŠ¡çš„æ›´ç›®å½•ä¸Šï¼Œå¯å°†æ–‡ç« å›¾ç‰‡ä¿å­˜åœ¨staticä¸Šï¼Œåœ¨æ–‡ä¸­ä½¿ç”¨ç»å¯¹è·¯å¾„å¼•ç”¨ã€‚å¦‚æœæœ‰ä½¿ç”¨å›¾å¢™æœåŠ¡åˆ™å½“æˆ‘æ²¡è¯´ã€‚\nç¼–è¯‘é™æ€ç½‘é¡µ é»˜è®¤å°†é™æ€ç½‘é¡µæ–‡ä»¶ç”Ÿæˆåœ¨./publicç›®å½•ä¸‹ï¼Œæ‰§è¡Œæ­¤å‘½ä»¤å°†åªç¼–è¯‘é™æ€ç½‘é¡µ\nhugo -D æœ¬åœ°è¿è¡Œ æ‰§è¡Œä¸‹æ–¹å‘½ä»¤å°†ä¼šæ ¹æ®æˆ‘ä»¬çš„æ–‡ä»¶åœ¨{content,data,layouts,static,themes}ç”Ÿæˆç›¸åº”æ–‡ä»¶ï¼Œå¹¶æœ¬åœ°å¯åŠ¨ä¸€ä¸ª å¯å®æ—¶æœåŠ¡é¢„è§ˆæ•ˆæœçš„æœåŠ¡ï¼Œè®¿é—®http://localhost:1313/\nhugo server -D github pagesé…ç½® åŸŸåå¤‡æ¡ˆæµç¨‹å¤šå°‘æ¯”è¾ƒèŠ±æ—¶é—´ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å°†åšå®¢éƒ¨ç½²åˆ°githubç»™æ¯ä¸ªå¸å·æä¾›çš„github pagesæœåŠ¡ä¸Šã€‚\ngithub.ioä»“åº“ github pagesæ‰˜ç®¡çš„é™æ€é¡¹ç›®ï¼Œéœ€è¦åˆ›å»ºä¸“é—¨çš„github.ioä»“åº“æ¥æ”¾ç½®ã€‚\nåˆ›å»ºé¡¹ç›®åç§°ä»¥\u0026lt;username.github.io\u0026gt;æ ¼å¼å‘½å å¿…é¡»é€‰æ‹©å…¬å¼€é¡¹ç›® å»ºè®®å‹¾é€‰æ·»åŠ READMEæ–‡ä»¶ å°†hugoé¡¹ç›®ç¼–è¯‘çš„publicæ–‡ä»¶å¤¹ä¸­çš„é™æ€ç½‘é¡µæ–‡ä»¶pushåˆ°æ­¤ä»“åº“ä¸­ï¼Œgithubå³å¯å°†æ­¤é™æ€ç½‘é¡µæ‰˜ç®¡è‡³å¯¹åº”çš„github.ioåŸŸåä¸Šã€‚ github-CI/CDé…ç½® ç°åœ¨ï¼Œæˆ‘ä»¬çš„åšå®¢å®é™…ä¾èµ–äº†ä¸¤ä¸ªé¡¹ç›®ï¼ŒåŒ…å«ä¸€ä¸ªåŸç”Ÿæ–‡ä»¶çš„hugoé¡¹ç›®ä»¥åŠä¸€ä¸ªç”¨æ¥æ¸²æŸ“é¡µé¢çš„github pagesé¡¹ç›®ã€‚ ä»»ä½•çš„æ›´æ–°æ“ä½œéƒ½éœ€è¦æ¶‰åŠè¿™ä¸¤ä¸ªä»“åº“çš„æ›´æ–°ï¼šä¿®æ”¹markdownæ–‡ä»¶-\u0026gt;hugoç¼–è¯‘é™æ€æ–‡ä»¶-\u0026gt;æ›´æ–°github pagesé¡¹ç›®-\u0026gt;ç½‘é¡µæ›´æ–°\nå› æ­¤ï¼Œä¸ºäº†èƒ½å¤Ÿæ–¹ä¾¿åœ°æ›´æ–°æ–‡ç« ï¼Œæˆ‘ä»¬éœ€è¦å°†ç¼–è¯‘å’Œå‘å¸ƒæµç¨‹å˜å¾—æ›´åŠ ä¾¿æ·æ›´åŠ è‡ªåŠ¨åŒ–ã€‚\ngithub actions actionæ˜¯githubæ”¯æŒçš„æ˜¯ä¸€å¥—æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜ (CI/CD) å¹³å°ï¼Œå¯ç”¨äºè‡ªåŠ¨æ‰§è¡Œç”Ÿæˆã€æµ‹è¯•å’Œéƒ¨ç½²ç®¡é“ã€‚ åœ¨é¡¹ç›®ä¸­æ–°å»º.github/workflowså·¥ä½œæµç›®å½•ï¼Œå®šä¹‰åšå®¢ç¼–è¯‘+éƒ¨ç½²çš„äº‹ä»¶ä»¥åŠä½œä¸šã€‚\nname: deploy run-name: ${{ github.actor }} is building out his hugo blog ğŸš€ on: workflow_dispatch: push: paths-ignore: - \u0026#39;.github/**\u0026#39; # workflow_dispatch: # schedule: # # Runs everyday at 8:00 AM # - cron: \u0026#34;0 0 * * *\u0026#34; jobs: build: runs-on: ubuntu-latest steps: - name: Checkout uses: actions/checkout@v3 with: submodules: true fetch-depth: 0 - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: \u0026#34;latest\u0026#34; - name: Build Web run: hugo - name: Deploy Web uses: peaceiris/actions-gh-pages@v3 with: PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }} EXTERNAL_REPOSITORY: Excaburay/Excaburay.github.io PUBLISH_BRANCH: master PUBLISH_DIR: ./public commit_message: ${{ github.event.head_commit.message }} å¦‚ä¸Šæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªdeployå·¥ä½œæµï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªbuildä½œä¸š å·¥ä½œæµè§¦å‘çš„äº‹ä»¶æˆ‘ä»¬é€‰æ‹©ä¸ºpushæ“ä½œ ä¸€ä¸ªä½œä¸šæ€»åŒ…å«äº†å¤šä¸ªæ“ä½œï¼Œé€šè¿‡Build Webæ“ä½œ(æ‰§è¡Œhugoå‘½ä»¤)æ¥ç¼–è¯‘æœ€æ–°é™æ€æ–‡ä»¶ é€šè¿‡Deploy Webæ“ä½œï¼Œæ¥å®Œæˆæ–°é™æ€æ–‡ä»¶çš„éƒ¨ç½² è‡³æ­¤ï¼Œæ¯æ¬¡æ›´æ–°æˆ‘ä»¬çš„hugoåšå®¢é¡¹ç›®æ—¶ï¼Œåªéœ€è¦åœ¨æ›´æ”¹åæ‰§è¡Œpushæ“ä½œï¼Œåšå®¢å°±å¯ä»¥å®Œæˆè‡ªåŠ¨æ›´æ–°ã€‚\nå¼€å§‹ä¸ºè‡ªå·±çš„åšå®¢ä¸°å¯Œå†…å®¹å§ï¼\n","permalink":"https://excaburay.github.io/posts/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/","summary":"ä½¿ç”¨hugoæ­å»ºåšå®¢\u0026ndash;è®°å½•æ­å»ºæ­¤åšå®¢çš„æœ€åˆæ­¥éª¤","title":"æ­å»ºhugoåšå®¢"},{"content":"å®‰è£…minikube ä¼ é€é—¨ï¼šhttps://minikube.sigs.k8s.io/docs/start/\n(è®°å¾—å®‰è£…kubectl,å¯ä»¥è‡ªå•ç‹¬å®‰è£…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡minikubeä¸‹è½½kubectl)\næ‰“å¼€æ§åˆ¶é¢æ¿\nminikube dashboard å‡†å¤‡æœåŠ¡ æœåŠ¡ä»£ç  æ¥ä¸ªä¼ ç»Ÿçš„http-server\nfunc rawHttpServer() { http.HandleFunc(\u0026#34;/hello\u0026#34;, func(w http.ResponseWriter, r *http.Request) { _, _ = w.Write([]byte(\u0026#34;hello world\u0026#34;)) }) if err := http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil); err != nil { fmt.Println(err) os.Exit(1) } } æœåŠ¡ç¼–è¯‘æ‰“åŒ… 1.ç¼–å†™DockerFile\nFROM golang:alpine AS builder RUN mkdir /app COPY . /app WORKDIR /app/httpdemo RUN go build -o httpdemo FROM alpine:3.18.2 WORKDIR /runtime COPY --from=builder /app/httpdemo/httpdemo /runtime/httpdemo ENTRYPOINT [\u0026#34;./httpdemo\u0026#34;] 2.æ‰“åŒ…é•œåƒ ç‰¹åˆ«æ³¨æ„ï¼Œå› ä¸ºé€‰æ‹©æœ¬åœ°æ‰“åŒ…ï¼Œåœ¨æ‰“åŒ…å‰éœ€è¦å°†minikubeçš„dockerç¯å¢ƒå˜é‡è®¾ç½®å¥½\n# æ­¤å‘½ä»¤å°†minikubeçš„docker-envåœ¨å½“å‰sessionä¸­è®¾ç½® eval $(minikube docker-env) # æ‰“åŒ…httpdemo:v1 docker build -t httpdemo:v1 -f httpdemo/Dockerfile . æœåŠ¡éƒ¨ç½² 1.åˆ›å»ºDeployment(å¯åŠ¨pod)\nå› ä¸ºDeploymenté»˜è®¤æ˜¯ä¼šä»hubä¸Šæ‹‰é•œåƒï¼Œå› æ­¤éœ€è¦å°†imagePullPolicyé…ç½®ä»ifNotPresentæ”¹ä¸ºNever\nkubectl create deployment http-demo --image=httpdemo:v1 --image-pull-policy=Never btw, å¯ä»¥é€šè¿‡-oé€‰é¡¹ç”Ÿæˆå½“å‰deploymenté…ç½®æ–‡ä»¶\nkubectl create deployment http-demo --image=httpdemo:v1 -o yaml # åœ¨ç”Ÿæˆçš„httpdemo.yamlä¸­ä¿®æ”¹imagePullPolicy # é‡æ–°æ ¹æ®é…ç½®åŠ è½½deployment kubectl apply -f httpdemo.yaml 2.åˆ›å»ºservice kubernetesé»˜è®¤podåªèƒ½åœ¨å…¶è™šæ‹Ÿå†…ç½‘ä¸­é€šä¿¡, è‹¥è¦å’Œå¤–ç½‘é€šä¿¡éœ€è¦å»ºç«‹service ```shell kubectl expose deployment http-demo --type=LoadBalancer --port=8080,8081 minikube service http-demo 3.æ‰“å¼€é¡µé¢ï¼Œå¯ä»¥æ­£å¸¸è®¿é—®æœåŠ¡\n","permalink":"https://excaburay.github.io/posts/kubernetesminikube%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1/","summary":"å°†æœ¬åœ°çš„httpæœåŠ¡ï¼Œæ‰“åŒ…ç¼–è¯‘ï¼Œå¹¶åœ¨minikubeä¸Šéƒ¨ç½²è¿è¡Œ","title":"kubernetes(minikube)éƒ¨ç½²æœåŠ¡"},{"content":"ç®€ä»‹ ratelimitæ˜¯uberæä¾›çš„ä¸€ä¸ªæç®€çš„æ¼æ¡¶é™æµå®ç°ï¼Œä¸»æ‰“ä¸€ä¸ªç®€çº¦è½»é‡ï¼Œåªæä¾›ä¸€ä¸ªæ¥å£æ¥å®ç°å¸¦é˜»å¡çš„é™æµèƒ½åŠ›ã€‚\nimport \u0026#34;go.uber.org/ratelimit\u0026#34; æ¼æ¡¶é™æµçš„æ–¹æ¡ˆï¼Œå³æŠ½è±¡ä¸€ä¸ªç±»ä¼¼æ¼æ¡¶çš„æ¦‚å¿µï¼Œè¯·æ±‚åªèƒ½æŒ‰ç…§æ’å®šçš„é€Ÿç‡ä»æ¡¶ä¸­â€œæ¼â€è¿‡ã€‚å…¶å®æ ¸å¿ƒæ˜¯æ§åˆ¶æµé€Ÿï¼Œæ¡¶ä¸æ¡¶çš„å¹¶ä¸é‡è¦ï¼›ä»uberå¯¹æ­¤çš„å®ç°ä¹Ÿèƒ½çœ‹å‡ºï¼Œæ ¸å¿ƒæ˜¯æŠŠæ¡é€Ÿç‡å³å•ä½æ—¶é—´å†…æ”¾è¡Œçš„æµé‡(è¯·æ±‚ä¸ªæ•°)ã€‚è®¡æ•°é™æµã€æ¼æ¡¶é™æµã€ä»¤ç‰Œæ¡¶é™æµè¿™ä¸‰ç§æ–¹æ¡ˆç›¸å…³çš„ä»‹ç»å·²ç»æœ‰å¾ˆå¤šäº†ï¼Œåœ¨æ­¤å°±ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚\næºç åˆ†æ ä»£ç ç»“æ„ New func New(rate int, opts ...Option) Limiter { return newAtomicInt64Based(rate, opts...) } rateå³ä¸ºæœ€å°å•ä½æ—¶é—´é€šè¿‡çš„è¯·æ±‚ä¸ªæ•°(å³æµé€Ÿ)ï¼›optionåŒ…å«ä¸‰ç§å¯é€‰é…ç½®ï¼šå¯æŒ‡å®šclockå®ç°ï¼Œslackæ¾å¼›åŒºé—´ï¼ŒperOptionæœ€å°æ—¶é—´å•ä½ Limiterå®šä¹‰ type Limiter interface { // Take should block to make sure that the RPS is met. Take() time.Time } å°±åªå®šä¹‰äº†ä¸€ä¸ªTakeæ–¹æ³•æ¥å®ç°é™æµï¼Œè¿”å›å½“å‰é€šè¿‡é™æµé€»è¾‘çš„æ—¶é—´ ratelimitå†…éƒ¨ä¿ç•™äº†ä¸‰ç§limiterå®ç°: æœ€åŸºç¡€çš„limiter_mutexbasedï¼Œæ”¹è¿›ä¸ºåŸå­é”çš„limiter_atomicï¼Œç®€åŒ–æ•°æ®ç»“æ„åçš„limiter_atomic_int64ã€‚çœŸæ­£æŠ•å…¥ä½¿ç”¨çš„æ˜¯æœ€åä¸€ç§limiter_atomic_int64ã€‚ ä»£ç å®ç° æ„Ÿè°¢uberå°†ç€ä¸‰ç§å®ç°éƒ½ä¿ç•™åœ¨äº†æ­¤é¡¹ç›®ä¸­ï¼Œä½¿å¾—æˆ‘ä»¬æœ‰æœºä¼šä»ä¸­æ„Ÿå—åˆ°å®ƒæ¯ä¸€æ¬¡çš„ä¼˜åŒ–äº†ä»€ä¹ˆï¼ŒèƒŒåçš„æ€è€ƒæ˜¯ä»€ä¹ˆã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬å¿«é€Ÿåˆ†æè¿™ä¸‰ä¸ªå®ç°ç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬å°±ä¸€ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œä»£ç é‡å¾ˆå°ï¼Œ\nlimiter_mutexbased // Take calls is on average per/rate. func (t *mutexLimiter) Take() time.Time { t.Lock() defer t.Unlock() now := t.clock.Now() // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œç›´æ¥æ”¾è¡Œ if t.last.IsZero() { t.last = now return t.last } // sleepFor è®¡ç®—çš„æ˜¯å¤„ç†å½“å‰è¯·æ±‚æˆ‘ä»¬éœ€è¦ç­‰å¾…å¤šé•¿æ—¶é—´ï¼Œå…¶å€¼é€šè¿‡å•ä¸ªè¯·æ±‚çš„æµé€Ÿä»¥åŠä¸Šä¸€ä¸ªè¯·æ±‚é€šè¿‡çš„æ—¶é—´æ¥å†³å®šã€‚ t.sleepFor += t.perRequest - now.Sub(t.last) // åœ¨ä¸€äº›æç«¯åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½å…è®¸sleepForæˆä¸ºä¸€ä¸ªå¾ˆå¤§çš„è´Ÿå€¼ï¼Œå¦åˆ™é‚£å°†ä»£è¡¨åç»­ç³»ç»Ÿå¯èƒ½å…è®¸æé«˜çš„RPSé€šè¿‡ã€‚ï¼ˆè¿™é‡Œçš„t.maxSlackæ˜¯ä¸ªè´Ÿæ•°ï¼‰ if t.sleepFor \u0026lt; t.maxSlack { t.sleepFor = t.maxSlack } // å¦‚æœsleepForæ˜¯å¤§äº0çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç­‰å¾… if t.sleepFor \u0026gt; 0 { t.clock.Sleep(t.sleepFor) t.last = now.Add(t.sleepFor) t.sleepFor = 0 } else { t.last = now } return t.last } æºç çš„è‹±æ–‡æ³¨é‡Šå…¶å®å·²ç»è®²å¾—å¾ˆæ˜ç™½äº†ï¼Œå¸Œæœ›æˆ‘å†™çš„ä¸­æ–‡ä¸ä¼šåè€Œå¢åŠ äº†ç†è§£éš¾åº¦ã€‚ è¿™é‡Œæ ¸å¿ƒç†è§£sleepForè¿™æ ·ä¸€ä¸ªç»“æ„å°±å¤Ÿäº†ï¼Œé€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œéƒ½åœ¨æ³¨é‡Šé‡Œäº†ã€‚ limiter_atomic func (t *atomicLimiter) Take() time.Time { var ( newState state taken bool interval time.Duration ) // çœŸæ­£äº’æ–¥çš„æ“ä½œæ˜¯CompareAndSwapPointerï¼Œåªæœ‰æ›¿æ¢æˆåŠŸæ‰ä»£è¡¨å¤„ç†äº†å½“å‰è¿™ä¸ªè¯·æ±‚ï¼Œå› æ­¤å¤–å›´ä¼šå¢åŠ ä¸€ä¸ªforå¾ªç¯ï¼›è¿™ä¸ªforå¾ªç¯å†…å¤§éƒ¨åˆ†é€»è¾‘éƒ½æ˜¯å¤„äºå¹¶å‘ä¸­çš„ã€‚ for !taken { now := t.clock.Now() previousStatePointer := atomic.LoadPointer(\u0026amp;t.state) oldState := (*state)(previousStatePointer) newState = state{ last: now, sleepFor: oldState.sleepFor, } // å¯¹ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œç›´æ¥æ”¾è¡Œ(å¹¶å‘åœºæ™¯å°±ç®—èµ°è¿›äº†è¿™ä¸ªåˆ†æ”¯é‡Œï¼Œå’±ä¹Ÿä¸çŸ¥è‡ªå·±æ˜¯ä¸æ˜¯çœŸæ­£çš„ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥è¿˜å¾—é€šè¿‡tokenåˆ¤æ–­) if oldState.last.IsZero() { taken = atomic.CompareAndSwapPointer(\u0026amp;t.state, previousStatePointer, unsafe.Pointer(\u0026amp;newState)) continue } // è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´ newState.sleepFor += t.perRequest - now.Sub(oldState.last) // slackå¤„ç† if newState.sleepFor \u0026lt; t.maxSlack { newState.sleepFor = t.maxSlack } // sleepForå¤§äºé›¶åˆ™è®°å½•éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œç¡çœ çš„æ—¶é—´ if newState.sleepFor \u0026gt; 0 { newState.last = newState.last.Add(newState.sleepFor) interval, newState.sleepFor = newState.sleepFor, 0 } taken = atomic.CompareAndSwapPointer(\u0026amp;t.state, previousStatePointer, unsafe.Pointer(\u0026amp;newState)) } t.clock.Sleep(interval) return newState.last } åªæœ‰CompareAndSwapPointerå¤„æ‰æ˜¯èµ„æºäº’æ–¥çš„ï¼Œå…¶å¤–å›´éƒ½æ˜¯å¹¶å‘åœºæ™¯ï¼Œå› æ­¤è¦å¢åŠ forå¾ªç¯ç›´åˆ°compareæˆåŠŸæ‰ä»£è¡¨å¤„ç†äº†å½“å‰çš„è¯·æ±‚å“ˆ æ¯æ¬¡è°ƒç”¨æ—¶ï¼Œå°†ä¸Šä¸€æ¬¡é€šè¿‡æ—¶é—´å’Œå½“å‰ç­‰å¾…æ—¶é—´(slackæ¾å¼›åº¦)ä½œä¸ºstateçŠ¶æ€ä»¥åŸå­é”ç»´æŠ¤ã€‚è¿™é‡Œçš„æ¯æ¬¡newState.sleepForéšå«äº†ç»§æ‰¿ä¸Šæ¬¡æœªä½¿ç”¨åˆ°çš„æ¾å¼›åº¦ã€‚ limiter_atomic_int64 func (t *atomicInt64Limiter) Take() time.Time { var ( newTimeOfNextPermissionIssue int64 now int64 ) for { now = t.clock.Now().UnixNano() timeOfNextPermissionIssue := atomic.LoadInt64(\u0026amp;t.state) switch { case timeOfNextPermissionIssue == 0 || (t.maxSlack == 0 \u0026amp;\u0026amp; now-timeOfNextPermissionIssue \u0026gt; int64(t.perRequest)): // if this is our first call or t.maxSlack == 0 we need to shrink issue time to now newTimeOfNextPermissionIssue = now case t.maxSlack \u0026gt; 0 \u0026amp;\u0026amp; now-timeOfNextPermissionIssue \u0026gt; int64(t.maxSlack): // a lot of nanoseconds passed since the last Take call // we will limit max accumulated time to maxSlack newTimeOfNextPermissionIssue = now - int64(t.maxSlack) default: // calculate the time at which our permission was issued newTimeOfNextPermissionIssue = timeOfNextPermissionIssue + int64(t.perRequest) } if atomic.CompareAndSwapInt64(\u0026amp;t.state, timeOfNextPermissionIssue, newTimeOfNextPermissionIssue) { break } } sleepDuration := time.Duration(newTimeOfNextPermissionIssue - now) if sleepDuration \u0026gt; 0 { t.clock.Sleep(sleepDuration) return time.Unix(0, newTimeOfNextPermissionIssue) } // return now if we don\u0026#39;t sleep as atomicLimiter does return time.Unix(0, now) } ä¸æ„§æ˜¯æœ€ç»ˆçš„å®ç°ç‰ˆï¼Œæœç„¶æ˜¯æœ€ç®€æ´çš„ã€‚é¦–å…ˆå°†é€»è¾‘ä¸­çš„æ¡ä»¶è¿›è¡Œæ•´åˆï¼Œç›´æ¥æ”¹æˆswitch caseçš„æ–¹å¼ï¼Œå¯è°“æ˜¯ä¸€ç›®äº†ç„¶ã€‚ å…¶æ¬¡ï¼Œä¿æŒçš„çŠ¶æ€åªéœ€è¦ç®€åŒ–æˆç›®æ ‡æ—¶é—´çš„æ—¶é—´æˆ³å°±å¯ä»¥äº†ï¼Œä¸€ä¸ªint64è¶³çŸ£ï¼Œä¸å¯ä¸è°“ä¹‹ç®€çº¦ã€‚ newTimeOfNexté€šè¿‡ç›´æ¥ç´¯åŠ ä¸€ä¸ªperRequestçš„æ–¹å¼ï¼Œä½¿å¾—ç´¯è®¡çš„slackæ¾å¼›é‡ç›´æ¥ä¿ç•™åœ¨äº†newTimeOfNextå’Œnowçš„æ—¶é—´å·®ä¸­ æ€»ç»“ æœ¬åº“ä½¿ç”¨æ–¹é¢\néœ€è¦é˜»å¡æµé‡ï¼Œä¸”é™æµé€Ÿç‡åŸºæœ¬å›ºå®šæ— éœ€è°ƒæ•´çš„åœºæ™¯ï¼Œç›´æ¥ä½¿ç”¨ratelimitç®€å•åˆçœäº‹ï¼› maxSlackè¯·ä¸€å®šè¦è®¾ç½®(æˆ–è®¾ç½®ä¸ºWithoutSlack)ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°æé«˜æµé‡å‡»ç©¿çš„åœºæ™¯ï¼› ä»£ç è®¾è®¡æ–¹é¢ ä¼˜åŒ–äº’æ–¥é€»è¾‘ï¼Œæœ‰ä¸€æ¡å¤§è·¯å³ä½¿ç”¨åŸå­é”ä»£æ›¿äº’æ–¥é”ã€‚å…¶ä¼˜åŒ–çš„æœ¬è´¨æ˜¯å‡å°‘äº†äº’æ–¥ç©ºé—´å†…çš„æ“ä½œï¼Œå°½å¯èƒ½æé«˜äº†å¹¶å‘åº¦ã€‚è€Œä½¿ç”¨åŸå­é”åœºæ™¯åŸºæœ¬éƒ½æ˜¯ç»†åŒ–äº’æ–¥èµ„æºåˆ°æŒ‡å®šå¯¹è±¡ï¼Œå°±å¦‚æ­¤é¡¹ç›®æ–¹æ¡ˆä¸€å’ŒäºŒä¹‹é—´çš„ä¼˜åŒ–ï¼› è€ç”Ÿå¸¸è°ˆçš„åŸºäºoptionçš„æ„é€ æ–¹æ³•ï¼Œæœ‰äº›å¯¹è±¡éƒ½å¯ä»¥æŠ½å‡ºæ¥ç›´æ¥è®©ä½¿ç”¨æ–¹è‡ªå·±å®ç°ï¼› åˆ†æ”¯é€»è¾‘çš„ä¼˜åŒ–ï¼Œèƒ½æŠ½å‡ºå…¬å…±çš„é€»è¾‘å°±ä¸€å®šè¦æŠ½å‡ºï¼Œå°½å¯èƒ½è®©åˆ†æ”¯çš„è·¯å£å’Œå°½å¤´éƒ½ä¸€ç›®äº†ç„¶ï¼› ","permalink":"https://excaburay.github.io/posts/ratelimit/","summary":"ratelimitæ˜¯uberæä¾›çš„ä¸€ä¸ªæç®€çš„æ¼æ¡¶é™æµå®ç°ï¼Œä¸»æ‰“ä¸€ä¸ªç®€çº¦è½»é‡ã€‚","title":"é™æµ--uber-ratelimit"}]